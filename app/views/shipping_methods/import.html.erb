<% content_for :title, 'Importar planilhas' %>

<% content_for :actions do %>
  <%= link_to 'http://planilha.zone', "http://planilha.zone", class: 'btn btn-success', target: "_blank" %>
<% end %>

<div class="selectbox correios-services">
  <label>
    <%= label_tag :service %>
    <%= select_tag :service, options_for_select(@correios_services.map{|k,v| [v,k]}), {prompt: "Selecione o serviÃ§o", class: "form-control"} %>
  </label>
</div>

<div class="selectbox correios-services">
  <label>
    <%= label_tag :type %>
    <%= select_tag :delivery_type, options_for_select(@delivery_types.map{|t| [t.name,t.id]}), {prompt: "Selecione o tipo de entrega", class: "form-control"} %>
  </label>
</div>

<div>
  <button id="import_now">Importar</button>
</div>

<div class="progress">
  <div class="progress-bar progress-bar-warning progress-bar-striped" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">
    <span class="sr-only">60% Complete</span>
  </div>
</div>

<div id="errors">
  <p style="display:none;">Linhas com erro</p>
  <ul></ul>
</div>

<textarea name="csv" style="font-family: 'Courier New'; width: 50%; font-size: 10px; height: 500px;"></textarea>

<SCRIPT TYPE="text/javascript">
  $(function(){
    var current_step = 0;
    var total_lines = 0;

    function incStep(){
      step = current_step++ / total_lines * 100;
      $('.progress-bar').css('width', step+'%').attr('aria-valuenow', step);
    }

    $("#import_now").on("click", function(){
      $('.progress-bar').css('width', current_step+'%').attr('aria-valuenow', current_step);
      $("#errors p").hide();
      $("#errors ul").html("");

      var arrayOfLines = $("textarea").val().split("\n");
      total_lines = arrayOfLines.length;
      current_step = 1;
      var service_id = $("#service").val();
      var service_name = $("#service option:selected").html();
      var delivery_type_id = $("#delivery_type").val();

      $.each(arrayOfLines, function(index, line){
        if(line.indexOf("ZipCodeStart") >= 0 || line.replace(/ /g,'') == "") { incStep() }
        else {
          $.post(
            '<%= import_line_shop_shipping_methods_path(params[:shop_id]) %>',
            {
              line: line,
              service_id: service_id,
              service_name: service_name,
              delivery_type_id: delivery_type_id
            }
          ).always(function(){
            incStep();
          }).error(function(){
            $("#errors p").show();
            $("#errors ul").append("<p>"+line+"</p>");
          });
        }
      });

      //step = 100;
      //$('.progress-bar').css('width', step+'%').attr('aria-valuenow', step);
    });
  });
</SCRIPT>
